// This is your Prisma schema file

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mongodb"
  url      = env("DATABASE_URL")
}

enum UserRole {
  HOST_PRIVATE
  PM_COMPANY
  CLEANER
  CLEANING_COMPANY
}

enum TaskStatus {
  open
  in_progress
  completed
}

enum Language {
  en
  el
}

enum InviteRole {
  CLEANER
  CO_HOST
}

model User {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  email     String   @unique
  password  String
  name      String?
  role      UserRole @default(HOST_PRIVATE)
  language  Language @default(en)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  properties         Property[]
  assignedTasks      Task[]              @relation("AssignedTasks")
  taskActivities     TaskActivity[]
  notifications      Notification[]
  propertyMembers    PropertyMember[]
  sentInvites        PropertyInvite[]    @relation("InviteSender")
}

model Property {
  id          String   @id @default(auto()) @map("_id") @db.ObjectId
  name        String
  description String?
  address     String?
  icalUrl     String?
  imageUrl    String?
  ownerId     String   @db.ObjectId
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  owner       User             @relation(fields: [ownerId], references: [id], onDelete: Cascade)
  bookings    Booking[]
  tasks       Task[]
  invites     PropertyInvite[]
  members     PropertyMember[]
}

model PropertyMember {
  id         String     @id @default(auto()) @map("_id") @db.ObjectId
  propertyId String     @db.ObjectId
  userId     String     @db.ObjectId
  role       InviteRole
  createdAt  DateTime   @default(now())

  property Property @relation(fields: [propertyId], references: [id], onDelete: Cascade)
  user     User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([propertyId, userId])
}

model Booking {
  id          String   @id @default(auto()) @map("_id") @db.ObjectId
  propertyId  String   @db.ObjectId
  externalUid String   @unique
  startDate   DateTime
  endDate     DateTime
  summary     String?
  source      String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  property Property @relation(fields: [propertyId], references: [id], onDelete: Cascade)
  tasks    Task[]
}

model Task {
  id           String     @id @default(auto()) @map("_id") @db.ObjectId
  propertyId   String     @db.ObjectId
  bookingId    String?    @db.ObjectId
  title        String
  dueDate      DateTime
  status       TaskStatus @default(open)
  assignedToId String?    @db.ObjectId
  notes        String?
  createdAt    DateTime   @default(now())
  updatedAt    DateTime   @updatedAt

  // Relations
  property     Property       @relation(fields: [propertyId], references: [id], onDelete: Cascade)
  booking      Booking?       @relation(fields: [bookingId], references: [id], onDelete: SetNull)
  assignedTo   User?          @relation("AssignedTasks", fields: [assignedToId], references: [id], onDelete: SetNull)
  activities   TaskActivity[]
}

model TaskActivity {
  id          String   @id @default(auto()) @map("_id") @db.ObjectId
  taskId      String   @db.ObjectId
  userId      String   @db.ObjectId
  action      String   // created, assigned, updated, completed
  description String
  createdAt   DateTime @default(now())

  // Relations
  task Task @relation(fields: [taskId], references: [id], onDelete: Cascade)
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model PropertyInvite {
  id         String      @id @default(auto()) @map("_id") @db.ObjectId
  propertyId String      @db.ObjectId
  email      String
  role       InviteRole
  token      String      @unique
  acceptedAt DateTime?
  senderId   String      @db.ObjectId
  createdAt  DateTime    @default(now())
  expiresAt  DateTime

  // Relations
  property Property @relation(fields: [propertyId], references: [id], onDelete: Cascade)
  sender   User     @relation("InviteSender", fields: [senderId], references: [id], onDelete: Cascade)
}

model Notification {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  userId    String   @db.ObjectId
  type      String   // task_assigned, task_due_date_changed
  message   String
  read      Boolean  @default(false)
  metadata  Json?
  createdAt DateTime @default(now())

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
}
